---
title: "Отслеживание местоположения пользователя"
description: "С помощью API геолокации можно определить, в каком месте находится пользователь, и отслеживать его перемещение – всегда с его согласия"
updated_on: 2014-10-21
key-takeaways:
  geo: 
    - "Перед тем как использовать API, всегда проверяйте совместимость."
    - "Сведите к минимуму отслеживание местоположения пользователя для экономии ресурса аккумулятора устройства."
    - "Всегда обрабатывайте ошибки."
---

<p class="intro">
  "С помощью API геолокации можно определить, в каком месте находится пользователь, и отслеживать его перемещение – всегда с его согласия
</p>

{% include shared/toc.liquid %}

Использование API не зависит от устройства; способ определения местоположения
браузером не имеет значения, поскольку клиенты могут запрашивать и получать данные
обычным способом. Для этого может использоваться GPS или Wi-Fi. Поскольку на выполнение любого 
такого запроса требуется некоторое время, API работает асинхронно; метод обратного вызова отправляется ему
 каждый раз, когда вы запрашиваете данные о местоположении.

{% include shared/takeaway.liquid list=page.key-takeaways.geo %}

## Ситуации, в которых следует использовать геолокацию для определения местоположения пользователя

* Необходимо получить более точные данные о местоположении пользователя.
* Необходимо обновить пользовательский интерфейс приложения на основе данных 
о новом местоположении пользователя.
* Необходимо обновить программный код приложения, реализующий его функциональные возможности, когда пользователь находится
 в определенной зоне.

## Отслеживание местоположения пользователя

С помощью API геолокации можно отслеживать местоположение пользователя (предварительно 
получив на это согласие пользователя), вызвав один раз метод `getCurrentPosition()`.  

Для непрерывного отслеживания местоположения пользователя в 
API геолокации предусмотрен метод `watchPosition()`. Он аналогичен методу 
`getCurrentPosition()`, только вызывается несколько раз, по мере того как:


1.  Программное обеспечение для определения местоположения получает точные данные о местонахождении пользователя.
2.  Местоположение пользователя изменяется.
 
{% highlight javascript %}
var watchId = navigator.geolocation.watchPosition(function(position) {
  document.getElementById('currentLat').innerHTML = position.coords.latitude;
  document.getElementById('currentLon').innerHTML = position.coords.longitude;
});
{% endhighlight %}

## Обязательная экономия энергии аккумулятора устройства

Отслеживание местоположения — это довольно ресурсоемкая операция.  В операционных 
системах могут быть реализованы функции
привязки приложения к подсистеме геопозиционирования, но вы как веб-разработчик не знаете, какая
 на устройстве пользователя имеется поддержка определения местоположения. В результате, когда вы определяете местоположение пользователя,
устройство вынуждено выполнять много излишней работы.

Когда отслеживание местоположения больше не требуется, вызовите метод `clearWatch`, чтобы 
отключить системы геопозиционирования.

## Всегда обрабатывайте ошибки

К сожалению, не все попытки определить местоположение венчаются успехом. Причиной может послужить невозможность подключиться к системе GPS
или внезапное отключение пользователем функций определения местоположения. В случае ошибки вызывается второй,
дополнительный аргумент для метода getCurrentPosition(),
и вы можете добавить в обратный вызов соответствующее уведомление для пользователя:

{% highlight javascript %}
window.onload = function() {
  var startPos;
  var geoSuccess = function(position) {
    startPos = position;
    document.getElementById('startLat').innerHTML = startPos.coords.latitude;
    document.getElementById('startLon').innerHTML = startPos.coords.longitude;
  };
  var geoError = function(position) {
    console.log('Error occurred. Error code: ' + error.code);
    // error.code can be:
    //   0: unknown error
    //   1: permission denied
    //   2: position unavailable (error response from location provider)
    //   3: timed out
  };
  navigator.geolocation.watchPosition(geoSuccess, geoError);
};
{% endhighlight %}



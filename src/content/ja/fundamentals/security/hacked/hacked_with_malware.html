<html devsite><head>
  <title>マルウェアを含むハッキング</title>
  <meta name="project_path" value="/web/fundamentals/_project.yaml"/>
  <meta name="book_path" value="/web/fundamentals/_book.yaml"/>
</head>
  <body>
<p>このステップは、マルウェアを配信する目的でハッキングされたサイトを対象としています。通常は検索結果に「このサイトはコンピュータに損害を与える可能性があります」という警告が表示されます。<em></em>これは、復旧プロセスで最も長いステップの 1 つです。サイト上の被害を受けたファイルのリストをこのステップで作成します。リストは、後の<a href="clean_site">サイトの問題を修正して管理する</a>ステップで使用します。</p>
  <p>サイトがマルウェアではなくスパムで侵害された場合は、検索結果に「このサイトは第三者によってハッキングされている可能性があります」という警告が表示されます。その場合は、<a href="hacked_with_spam">被害の程度を確認する（スパムを含むハッキング）</a>の記事をご覧ください。<em></em></p>

    <div class="video-wrapper">
      <iframe class="devsite-embedded-youtube-video" data-video-id="Snt45fZQIiU" data-autohide="1" data-showinfo="0" frameborder="0" allowfullscreen>
      </iframe>
    </div>

<h3>必要なもの:</h3>
<ul>
  <li>サイトのサーバー（ウェブ、データベース、ファイル）へのシェルまたはターミナルの管理者アクセス権限。</li>
  <li>シェルまたはターミナルのコマンドの知識。</li>
  <li>データベースに対して SQL クエリを実行する能力。</li>
</ul>
<h3>実施する対策:</h3>

<div class="action">
<p>このステップには 3 つのセクションがあります:</p>
<ul>
  <li><a href="#preparation">準備</a></li>
  <li><a href="#investigation">各タイプのマルウェア感染の調査</a></li>
  <li><a href="#assessment">ファイルシステムの被害全般の評価</a></li>
</ul>
</div>

<a name="preparation"></a>
<h3>準備</h3>
<ol>
  <li>ブラウザを使ってサイトのページを表示するのは避けてください。マルウェアはブラウザの脆弱性を利用して広がる場合が多いため、マルウェアに感染したページをブラウザで開くと、パソコンに被害が及ぶおそれがあります。</li>
  <li>このステップで調べたことを記録するドキュメントを作成します。ドキュメントには最終的に最低限、被害を受けた各ファイルの名前と場所を記入し、感染の内容を記述します。このドキュメントは、<a href="clean_site">サイトの問題を修正して管理する</a>ステップの基礎資料となります。</li>
  <li>必要に応じて、追加資料を確認します。
    <ul>
      <li>上の動画を再生し、マルウェアの仕組みや、マルウェアの調査中に安全を確保する方法をご覧ください。</li>
      <li><a href="/safe-browsing/">Google セーフ ブラウジングの診断ページ</a>を表示して、サイトがユーザーにとって有害である可能性についての公開情報をご覧ください。次のような URL でサイトのステータスのリストを確認できます。
      <pre>http://www.google.com/safebrowsing/diagnostic?site=&lt;your-site&gt;</pre>
      例:
      <code>http://www.google.com/safebrowsing/diagnostic?site=webmastercentralblog.blogspot.com</code></li>
    </ul>
  </li>
  <li><a href="https://www.google.com/search?q=cURL">cURL</a> または <a href="https://www.google.com/search?q=Wget">Wget</a> を使って、HTTP リクエスト（ページの取得など）を行います。
    <p>無料で入手できるこうしたツールは、リダイレクトの診断に便利なうえ、リファラーやユーザー エージェントの情報を指定できる柔軟性もあります。特定のリファラーやユーザー エージェントを指定できると、ハッキングを再現する精度も上がります。ハッカーは、実体を持つ人物である確率が高いユーザーだけを標的にするために、特定のユーザー エージェントやリファラーを使用するユーザーにのみ悪質なコンテンツを配信し、サイト所有者やマルウェア スキャナによる検出を逃れる傾向があるからです。</p>
    <pre>$curl -v --referer "http://www.google.com" &lt;your-url&gt;</pre></li>
</ol>

<a name="investigation"></a>
<h3>サイトでの各タイプのマルウェア感染の調査</h3>
<ol>
  <li>確認済みのサイトを Search Console で選択し、[<strong>セキュリティの問題</strong>] をクリックします。</li>
  <li>サイトの [セキュリティの問題] に表示されたすべてのマルウェア カテゴリ（サーバーの設定、SQL インジェクションなど）を調べます。[詳細を表示] をクリックすると、そのカテゴリの感染した URL に関する追加情報が表示されます（詳細には、ハッカーによって挿入されたコード スニペットのサンプルが表示される場合があります）。カテゴリごとに、次の項目を調査用ドキュメントにコピーします。
    <ul>
      <li>[セキュリティの問題] のマルウェア カテゴリに表示される感染した URL のすべての例。</li>
      <li>調査中に判明した、被害を受けたその他のページ。</li>
      <li>感染した URL について判明した詳細情報（発生した被害のタイプなど）。</li>
    </ul>
  </li>
  <li>各マルウェア タイプの調査に役立つ情報は次のとおりです。
    <ul>
      <li><a href="https://www.support.google.com/webmasters/answer/3024318">サーバー設定</a></li>
      <li><a href="https://www.support.google.com/webmasters/answer/3024309">SQL インジェクション</a></li>
      <li><a href="https://www.support.google.com/webmasters/answer/3024381">エラー テンプレート</a></li>
      <li><a href="https://www.support.google.com/webmasters/answer/3024344">コード インジェクション</a></li>
    </ul>
  </li>
</ol>

<a name="assessment"></a>
<h4>ファイルシステムの被害の評価</h4>
        <div class="video-wrapper">
      <iframe class="devsite-embedded-youtube-video" data-video-id="2A4dLkXXUjo" data-autohide="1" data-showinfo="0" frameborder="0" allowfullscreen>
      </iframe>
    </div>

<p>次に、より詳細な調査を行うため、サイトのファイルシステムにログインする必要があります。特に注意が必要なハッカーの手口として、既存のページやデータベース レコードを変更する、まったく新しいスパムページを作成する、正常なページにスパムを表示する関数を記述する、サイトに再び侵入するための「裏口」を残しておき、削除されない限り悪意のあるタスクを実行し続けるなどが考えられます。</p>
<p>サイトがオンラインの場合は、オフラインに戻してから以下の手順に入ってください。</p>
<ol>
  <li>正常であることを確認したバックアップがサイトにあれば、そのバックアップ以降に作成または変更されたファイルを特定します。後で詳しく調査できるように、特定したファイルをリストに追加します。Unix ベースのシステムでは、次のようなコマンドを使用できます。
  <pre>$ diff -qr &lt;current-directory&gt; &lt;backup-directory&gt;</pre>
  例:
  <pre>$ diff -qr www/ backups/full-backup-20120124/</pre>
  または
  <pre>$ md5sum &lt;current-page&gt; &lt;backup-page&gt;</pre>
  例:
  <pre>$ md5sum www/page.html backups/full-backup-20120124/page.html</pre></li>
  <li><strong>サーバーログ、アクセスログ、エラーログ</strong>で、疑わしいアクティビティがないかどうか確認します。失敗したログイン試行、コマンド履歴（特にルート権限のもの）、不明なユーザー アカウントの作成などが考えられます。なお、ハッカーがこれらのログを自分に都合よく改変している場合もあります（<a href="vulnerability">脆弱性を特定する</a>動画の例を参考までにご覧ください）。</li>
  <li>.htaccess や httpd.conf などの<strong>設定ファイル</strong>で、リダイレクトがないかどうかを確認します。ハッカーはユーザー エージェント、時間帯、リファラーなどに応じた条件付きのリダイレクトを作成することがよくあります。</li>
  <li>フォルダやファイルに緩すぎる権限がないかどうかを確認します。サイト所有者が緩い権限を検出できないと、ハッカーがサイトに再び侵入できるため、権限が改ざんされます。権限が 644（rw-r--r--）より大きいファイルや 755（rwxr-xr-x）より大きいフォルダは、セキュリティの問題となるおそれがあります。緩く設定した権限が本当に必要かどうかを確認します。Unix ベースのシステムでは、次のコマンドを試します。
  <pre>$ find &lt;your-dir&gt; -type d -not -perm 755 -exec ls -ld {} \;</pre>
  <pre>$ find &lt;your-dir&gt; -type f -not -perm 644 -exec ls -la {} \;</pre></li>
  <li>データベースがある場合は、<a href="https://www.phpmyadmin.net/home_page/index.php">phpMyAdmin</a> などのツールを使って各レコードを調べます。</li>
</ol>

<h2>次のステップ</h2>
<p>プロセスの次のステップは、<a href="vulnerability">サイトの脆弱性を特定する</a>です。</p>

</body></html>

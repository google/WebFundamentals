<html devsite><head>
  <title>サイトの問題を修正して管理する</title>
  <meta name="project_path" value="/web/fundamentals/_project.yaml"/>
  <meta name="book_path" value="/web/fundamentals/_book.yaml"/>
</head>
  <body>
<h3>必要なもの:</h3>

<ul>
  <li>サイトのサーバー（ウェブ、データベース、ファイル）へのシェルまたはターミナルの管理者アクセス権限</li>
  <li>シェルまたはターミナルのコマンドの知識</li>
  <li>コードの理解（PHP や JavaScript など）</li>
  <li>サイト（ファイル、データベース、画像など）のバックアップを作成するためのストレージ</li>
</ul>
    <div class="video-wrapper">
      <iframe class="devsite-embedded-youtube-video" data-video-id="OAvydrgDa6Q" data-autohide="1" data-showinfo="0" frameborder="0" allowfullscreen>
      </iframe>
    </div>

<h3>次の対策:</h3>

<p>このステップでは、複数の対策について説明します。</p>

<ul>
  <li>ハッカーがユーザーの個人情報を（フィッシング ページなどで）入手しようとしたと思われる場合に、サポートの情報源を探す。</li>
  <li>ユーザーから見える状態にある、ハッカー作成の完全に新しい不正な URL（Google 検索結果に表示したくない URL）を Search Console の <a href="https://www.google.com/webmasters/tools/removals">URL の削除</a>ツールを使って削除する（省略可）。</li>
  <li>新しく作成または新たに更新された正常なページ（Google 検索結果に表示したいページ）の Google による処理を Search Console の <a href="https://www.support.google.com/webmasters/answer/1352276">Fetch as Google</a> 機能を使って早める（省略可）。</li>
  <li>ソフトウェアの最も安全な最新版をインストールする。</li>
  <li>今後のサイトの脆弱性につながるおそれのある、使用しないまたは不要なアプリケーションやプラグインを削除する。</li>
  <li>正常なコンテンツを復元し、ハッカーのコンテンツを削除する。</li>
  <li>ハッカーに利用された根本原因の脆弱性を修正する。</li>
  <li>すべてのパスワードを変更する。</li>
  <li>サイトの安全性を維持するプランを立てる。</li>
</ul>

<h4>1. フィッシング ページなどでサイトの機密情報が失われた場合に、対処できるようにサポート情報源を見つける</h4>

<p>サイトからユーザーの機密情報が（たとえば、フィッシング攻撃の一部として）漏れた場合、サイトのクリーンアップやファイルの削除を開始する前に、ビジネス上、規制上、法律上の責任について検討することをおすすめします。フィッシングの場合は、<a href="https://antiphishing.org">antiphishing.org</a> に役立つ情報があります（<a href="https://docs.apwg.org/reports/APWG_WTD_HackedWebsite.pdf">サイトがフィッシングによってハッキングされた場合のガイド</a>など）。</p>

<h4>2. ハッカーによって作成された新しい URL の迅速な削除を検討する</h4>

<p>ハッカー作成の完全に新しい URL がユーザーから見える状態で存在する場合は、Search Console の <a href="https://www.google.com/webmasters/tools/removals">URL の削除</a>ツールを使って、こうしたページをより早急に Google の検索結果から削除することができます。これは省略可能なステップです。該当するページを削除してから、<a href="https://www.support.google.com/webmasters/answer/40132">404 ステータス コード</a>を返すようにサーバーを設定するだけでも、時間が経つうちに自然に、そのページは Google のインデックスに登録されなくなります。</p>

<ul>
  <li>URL の削除ツールを使用するかどうかの判断は、新たに作成された不要なページの数や（ページが多すぎると [URL の削除] での指定が煩雑になります）、こうしたページがユーザーに及ぼすおそれのある被害の内容によって異なります。[URL の削除] で送信したページが今後検索結果に表示されないようにするには、不要なまたは削除した URL に対して「404 ファイルが見つかりません」というレスポンスを返すようにページを必ず設定します。</li>
  <li>ハッカーによる侵害を受ける前は正常なページだったので、クリーンアップ後はこのページを検索結果に表示させたいという場合は、この機能でページの削除をリクエストしないでください。
    <em>[URL の削除] は、今後一切結果に表示させたくないページにのみ使用します。</em></li>
</ul>

<h4>3. Google による正常なページの処理を早めるかどうか検討する</h4>

<p>新しく作成または新たに更新された正常なページがある場合、Search Console の <a href="https://www.support.google.com/webmasters/answer/1352276">Fetch as Google</a> 機能を使って、こうしたページを Google のインデックスに送信できます。これは省略可能なステップです。省略しても、時間が経つうちに、新しいまたは更新したページはクロールされ、処理されます。</p>

<h4>4. サーバーのクリーンアップを開始する</h4>

<p>ここで、<a href="hacked_with_spam">被害の程度の確認</a>と<a href="vulnerability">脆弱性の特定</a>で取った記録に基づいて、サイトのクリーンアップを開始します。以下の手順は、利用できるバックアップのタイプによって異なります。</p>

<ul>
  <li>正常な最新のバックアップ</li>
  <li>正常だが古い状態のバックアップ</li>
  <li>バックアップが利用できない</li>
</ul>

<p>まず、サイトがハッキングされる<strong>前に</strong>このバックアップが作成されたことを確認します。</p>

<ul>
  <li><strong>正常な最新のバックアップ</strong>

    <ol>
      <li>バックアップを復元します。</li>
      <li>入手可能なソフトウェアのアップグレード、アップデート、パッチをインストールします。これは、OS のソフトウェア（サーバーを管理している場合）と、すべてのアプリケーション（コンテンツ管理システム、e コマース プラットフォーム、プラグイン、テンプレートなど）が対象となります。</li>
      <li>サイトで使用しなくなったソフトウェア（ウィジェット、プラグイン、アプリケーションなど）をサーバーから削除できるかどうか検討します。</li>
      <li>脆弱性を修正します。</li>
      <li><a href="hacked_with_spam">被害の程度の確認</a>で見つかったすべての問題に対処したかどうかを確認します。</li>
      <li>サイトに関するすべてのアカウント（FTP アクセス、データベース アクセス、システム管理者、CMS アカウントなどのログイン）のパスワードを再度変更します。Unix ベース システムでは、次のコマンドを実行します。
           <pre>
$passwd admin1</pre>
      </li>
    </ol>
  </li>
  <li><strong>正常だが古い状態のバックアップ</strong>
    <ol>
      <li>現在のサイトのディスク イメージを作成します。サイトが感染している状態でもかまいません。このコピーは安全のためです。他のものと区別するため、感染していることがわかるようにコピーに印を付けます。Unix ベース システムでは、次のようにディスク イメージを作成します。
        <pre>
$dd if=/dev/sda bs=1024 conv=noerror,sync | gzip -c -9
  &gt; /mirror/full-backup-20120125-infected.gz</pre>
      </li>
      <li>画像やメディア ファイルを含む、サーバーのバックアップ ファイル システムのコピーを作成します。データベースがある場合は、データベースもバックアップします。
        <pre>
$tar -pczf full-backup-20120125-infected.tar.gz www/ $ mysqldump -u root
  -p --all-databases | gzip -9 &gt; fulldb_backup-20120125-infected.sql</pre>
      </li>
      <li>正常だが古い状態のバックアップをサーバー上で復元します。</li>
      <li>サイトで使用しなくなったソフトウェア（ウィジェット、プラグイン、アプリケーションなど）をサーバーから削除できるかどうか検討します。</li>
      <li>すべてのソフトウェアをアップグレードします。OS のソフトウェア（サーバーを管理している場合）と、すべてのアプリケーション（コンテンツ管理システム、e コマース プラットフォーム、プラグイン、テンプレートなど）が対象となります。入手可能なセキュリティ アップデートとパッチを確認して、インストールします。</li>
      <li>脆弱性を修正します。</li>
      <li>手動または自動で、サイトの <code>diff</code> を実行します（正常なバックアップと現在の感染しているコピーを比較します）。
        <pre>
$diff -qr www/ backups/full-backup-20120124/</pre>
      </li>
      <li>感染したコピーから保護したい新しい正常なコンテンツがあれば、アップグレード済みのサーバーにアップロードします。
        <pre>
$rsync -avz /backups/full-backup-20120124/www/clean-file.jpg /www/</pre>
      </li>
      <li><a href="hacked_with_spam">被害の程度の確認</a>で見つかったすべての URL を修正したかどうかを確認します。</li>
      <li>サイトに関するすべてのアカウント（FTP アクセス、データベース アクセス、システム管理者、CMS アカウントなどのログイン）のパスワードを再度変更します。Unix ベース システムでは、次のコマンドを実行します。
           <pre>
$passwd admin1</pre>
      </li>
    </ol>
  </li>
  <li><strong>バックアップが利用できない</strong>
    <ol>
      <li>サイトのバックアップを 2 つ作成します。サイトが感染している状態でもかまいません。余分にバックアップを作成しておくと、誤って削除したコンテンツを復元したり、うまくいかない場合に元に戻してもう一度試したりできます。後でわかりやすいように、各バックアップに「感染」という印を付けます。
        <ul>
          <li>バックアップの 1 つはサイトのディスク イメージ（「クローン版」）とします。このフォーマットはコンテンツの復元が簡単になります。ディスク イメージを万一に備えて手元に残しておくことができます。Unix ベース システムでは、次のようにディスク イメージを作成できます。
            <pre>
$dd if=/dev/sda bs=1024 conv=noerror,sync | gzip -c -9 &gt;
  /mirror/full-backup-20120125-infected.gz</pre>
          </li>
          <li>もう 1 つのバックアップは、画像やメディア ファイルを含む、サーバーのファイル システムのコピーです。データベースがある場合は、データベースもバックアップします。
            <pre>
$tar -pczf full-backup-20120125-infected.tar.gz www/</pre>
             

            <pre>
$mysqldump -u root -p --all-databases | gzip -9 &gt; fulldb_backup-20120125-infected.sql</pre>
          </li>
          <li>ディスク イメージがない場合は、データベースのバックアップを 2 つと、ファイルシステムのバックアップを 2 つ作成します。</li>
        </ul>
      </li>
      <li>サーバー上ではなく、新しいバックアップ ファイルシステムのコピー上で、サイトのコンテンツをクリーンアップします。
        <ol>
          <li>これまでに調べて、ファイルに緩すぎる権限が見つかった場合は、権限を修正します。この修正は必ず、サーバー上ではなく、バックアップ コピー上で行います。</li>
          <li>同様にバックアップ コピー上で、<a href="hacked_with_spam">被害の程度の確認</a>で不正使用が見つかった URL に対応するすべてのファイルをクリーンアップします。サーバーの設定ファイル、JavaScript、HTML、PHP などが対象です。</li>
          <li>ハッカーによって作成された新しいファイルも削除（404 レスポンスを配信）します（これらのファイルは、Search Console の [URL の削除] ツールで送信済みの場合があります）。</li>
          <li>コードや解読されたパスワードに脆弱性がある場合は修正します。入力検証ライブラリやセキュリティ監査が役立つことがあります。</li>
          <li>サイトにデータベースがある場合は、バックアップ内のハッカーに変更されたレコードのクリーンアップを開始します。この手順を完了する前に、その他のレコードの正当性チェックを実行して、正常な状態かどうかを確認します。</li>
          <li>サイトに関するすべてのアカウント（FTP アクセス、データベース アクセス、システム管理者、CMS アカウントなどのログイン）のパスワードを再度変更します。Unix ベース システムでは、次のコマンドを実行します。
            <pre>
$passwd admin1</pre>
          </li>
          <li>この時点で、感染していたサイトのバックアップ コピーには正常なデータのみが含まれているはずです。この正常なコピーを手元に保管して、対策 5 に進んでください。</li>
        </ol>
      </li>
    </ol>
  </li>
</ul>

<h4>5. 不要なソフトウェアを除去する</h4>

<p>サイトで使用しなくなったソフトウェア（ウィジェット、プラグイン、アプリケーションなど）をサーバーから削除できるかどうか検討します。削除するとセキュリティが向上し、今後の管理が簡単になります。</p>

<h4>6. すべてのサーバーをクリーンアップする</h4>

<ol>
  <li>単にアップグレードするのではなく、クリーン インストールを行います。アップグレードでは、古いバージョンのファイルが残ることがあります。感染したファイルがサーバーに残ると、新たなハッキングが起きる可能性が高まります。
    <ul>
      <li>クリーン インストールは、OS のソフトウェア（サーバーを管理している場合）と、すべてのアプリケーション（コンテンツ管理システム、e コマース プラットフォーム、プラグイン、テンプレートなど）が対象となります。入手可能なセキュリティ アップデートとパッチも必ず確認します。</li>
    </ul>
  </li>
  <li>バックアップ ファイルシステムのクリーンアップしたコピーから、新たにインストールしたサーバーに正常なコンテンツを移行します。正常な既知のファイルとデータベースのみをアップロード、復元します。ファイルの適切な権限を管理し、新たにインストールしたシステム ファイルを上書きしないようにします。</li>
  <li>サイトに関するすべてのアカウント（FTP アクセス、データベース アクセス、システム管理者、CMS アカウントなどのログイン）のパスワードを最後にもう一度変更します。Unix ベース システムでは、次のコマンドを実行します。
    <pre>
$passwd admin1</pre>
  </li>
</ol>

<h4>7. 長期の管理計画を作成する</h4>

<p>ウェブ上にはサイトの強力な管理の参考になる便利な情報が多数あります（StopBadware の <a href="https://www.stopbadware.org/prevent-badware-basics">Preventing badware: basics</a> など）。また、次の手順を行うことも強くおすすめします。</p>

<ul>
  <li>サイトを定期的に自動バックアップする。</li>
  <li>ソフトウェアの更新に常に気を配る。</li>
  <li>サーバーにインストールする前に、すべてのアプリケーション、プラグイン、サードパーティ ソフトウェアなどのセキュリティ対策を把握しておく。あるソフトウェア アプリケーションにセキュリティの脆弱性があると、サイト全体の安全性が損なわれるおそれがあります。</li>
  <li>強力なパスワードを作成する。</li>
  <li>マシンへのログインに使用するすべてのデバイスを安全に保つ（オペレーティング システムとブラウザを更新する）。</li>
</ul>

<h4>8. クリーンアップの完了を再確認する</h4>

<p>次の質問に「はい」と答えられるかどうかを確認します。</p>

<ul>
  <li>ハッカーがユーザーの個人情報を入手している場合、適切な手順を行いましたか？</li>
  <li>最も安全な最新版のソフトウェアをサイトで実行していますか？</li>
  <li>今後のサイトの脆弱性につながるおそれのある、使用しないまたは不要なアプリケーションやプラグインをすべて削除しましたか？</li>
  <li>コンテンツを復元して、ハッカーのコンテンツを削除しましたか？</li>
  <li>サイトのハッキングを許した根本原因の脆弱性を修正しましたか？</li>
  <li>サイトを安全に保つための計画はありますか？</li>
</ul>

<h4>9. サイトをオンラインに戻す</h4>
<h2>次のステップ</h2>
<p>完了まであと一息です。このプロセスの最後の手順は、<a href="request_review">再審査のリクエスト</a>です。</p>

</body></html>

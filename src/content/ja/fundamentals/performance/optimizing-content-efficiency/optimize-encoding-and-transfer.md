project_path: /web/_project.yaml
book_path: /web/fundamentals/_book.yaml
description: 不要なリソースを取り除いたら、次の手順はブラウザがダウンロードしなければならない残りのリソースの合計サイズを最小限に抑えることです。つまり、コンテンツ種類別の圧縮アルゴリズムと汎用の圧縮アルゴリズム（GZip）を適用してリソースを圧縮します。

{# wf_updated_on: 2014-09-11 #}
{# wf_published_on: 2014-03-31 #}

# テキストベースのアセットのエンコードと転送サイズの最適化 {: .page-title }

{% include "web/_shared/contributors/ilyagrigorik.html" %}



ウェブ アプリケーションは、その対象範囲、規模、機能の点で成長を続けています。それは良いことですが、ウェブを充実させるための絶え間ない進歩は、アプリケーションでダウンロードされるデータの量も一定のペースで増え続ける、という傾向も招いています。パフォーマンスを最適にするには、バイト 1 つ 1 つの配信を最適化することが必要です。




## データ圧縮 101

不要なリソースをすべて取り除いたら、次の手順はブラウザがダウンロードする必要がある残りのリソースの合計サイズを最小限に抑える、つまり圧縮することです。リソースの種類（テキスト、画像、フォントなど）に応じて、サーバーで有効な汎用ツール、コンテンツの種類別の前処理最適化、デベロッパーの入力を必要とするリソース別の最適化など、自由に利用できるさまざまな技術があります。

パフォーマンスを最適にするには、このすべての技術を組み合わせる必要があります。

### TL;DR {: .hide-from-toc }
- 圧縮とは、ビット数を削減して情報をエンコードする処理である
- 不要なデータを取り除くことで常に満足のいく結果を得る
- さまざまな圧縮技術と圧縮アルゴリズムがある
- 最適な圧縮を実現するにはさまざまな技術が必要である


データサイズを縮小する処理のことを「データ圧縮」と呼びます。それだけでも難しい研究分野です。多くの人がその生涯をかけてアルゴリズム、技術、最適化に取り組み、圧縮率、圧縮速度、各種圧縮に必要なメモリ容量を向上させてきました。言うまでもなく、このテーマをすべて説明することがここでの目的ではありませんが、重要なのは、圧縮の仕組みと、ページに必要な各種アセットのサイズを縮小するために自由に利用できる技術を、大まかに理解することです。

実践されているこうした技術の主な方針を示すため、この例のためだけに作成した単純なテキスト メッセージ形式を最適化するにはどうすればよいかを検討してみましょう。

    # 以下は秘密のメッセージで、key-value 形式の一連のヘッダー、
    # 改行、暗号化メッセージの順に構成されています。
    format: secret-cipher
    date: 04/04/14
    AAAZZBBBBEEEMMM EEETTTAAA

1. メッセージには、「#」の接頭辞で指定される、任意の注釈が含まれている可能性があります。注釈はメッセージの意味やその他の振る舞いには影響しません。
2. メッセージには、key-value ペアの「ヘッダー」が（「:」で区切られて）含まれている可能性があります。このヘッダーはメッセージの先頭に表示する必要があります。
3. メッセージで伝送されるのはテキストのペイロードです。

現時点で長さが 200 文字ある上記のメッセージのサイズを削減するにはどうすればよいでしょうか。

1. コメントは興味深いですが、メッセージの意味に影響しないことがわかっているので、メッセージを送信する際に取り除きます。
2. ヘッダーを効率的にエンコードするために使用できる高度な技術がありそうです。たとえば、すべてのメッセージに必ず「format」と「date」があるかどうかはわかりませんが、これらがあれば、短い整数 ID に変換しその ID を送信することができます。ただ、このケースに当てはまるかどうかわからないので、とりあえずヘッダーはそのまま残しておきます。
3. ペイロードはテキストのみです。テキストのコンテンツが実際に何かはわかりませんが（「秘密のメッセージ」を使用していることは明らかですが）、テキストを見ると、かなり冗長性があるようです。文字の繰り返しを送信するのではなく、繰り返されている文字の数を数えることで、もっと効率的にエンコードできるのではないでしょうか。
    * たとえば、「AAA」は「3A」になります。A が 3 つ連続しているという意味です。


この技術を組み合わせると、次のような結果になります。

    format: secret-cipher
    date: 04/04/14
    3A2Z4B3E3M 3E3T3A

新しいメッセージの長さは 56 文字です。つまり、元のメッセージを 72% も圧縮できたことになります。すべて考慮されており、始めたばかりにしては上出来です。

もちろん、判断に迷うこともあります。これは上出来ですが、このことがウェブページの最適化にどう役立つのでしょうか。圧縮アルゴリズムを発明しようとしているわけではありません。発明するわけではありませんが、おわかりのように、最適化するページ上のリソースは変わっても、前処理、コンテキスト別の最適化、コンテンツ別のアルゴリズムなど、使用する技術と考え方はまったく同じです。


## 縮小化: 前処理とコンテキスト別の最適化

### TL;DR {: .hide-from-toc }
- コンテンツ別の最適化により、配信するリソースのサイズを大幅に削減できる
- コンテンツ別の最適化はビルド / リリース サイクルの一部として適用することが推奨される


冗長なデータや不要なデータを圧縮する最も良い方法は、一緒に取り除くことです。もちろん、データをやたらに削除することはできませんが、データ形式とそのプロパティについてコンテンツ別の知識があれば、実際の意味に影響を与えることなくペイロードのサイズを大幅に削減することが可能です。

<pre class="prettyprint">
{% includecode content_path="web/fundamentals/performance/optimizing-content-efficiency/_code/minify.html" region_tag="full" adjust_indentation="auto" %}
</pre>

上記のシンプルな HTML ページと、そのページに含まれる 3 つの異なるコンテンツの種類（HTML マークアップ、CSS スタイル、JavaScript）を考えてみましょう。コンテンツの種類ごとに、有効な HTML マークアップを作成するためのルール、CSS のルール、JavaScript コンテンツのルールや、コメントを示すためのルールなどは異なります。このページのサイズを縮小するにはどうすればよいでしょうか。

* コードのコメントはデベロッパーにとっては非常に役立ちますが、ブラウザでコメントを表示する必要はありません。CSS（/* … */）、HTML（<!-- … -->）、JavaScript（// …）の各コメントを除去するだけで、ページの合計サイズは大幅に縮小されます。
* 「スマート」な CSS 圧縮ツールがあれば、「.awesome-container」のルール」が効率よく定義されていないことが認識され、他のスタイルに影響を与えずに 2 つの宣言を 1 つにできるため、バイト数はさらに削減されます。
* 空白（スペースとタブ）は、デベロッパーが HTML、CSS、JavaScript で便宜上使っているものです。タブとスペースをすべて削除できる圧縮ツールもあります。

<pre class="prettyprint">
{% includecode content_path="web/fundamentals/performance/optimizing-content-efficiency/_code/minified.html" region_tag="full" adjust_indentation="auto" %}
</pre>

上記の手順を適用すれば、ページは最終的に 406 文字から 150 文字に減ります。圧縮率 63% です。確かにあまり読みやすくはありませんが、読みやすくする必要もありません。元のページは「開発バージョン」として保存しておき、ページをウェブサイトに公開できる準備ができたらいつでも上記の手順を適用できます。

一歩離れてみると、上記の例から重要な点がわかります。汎用の圧縮ツール、いわゆる任意のテキストを圧縮するように作られたツールは、上記のページを圧縮するといった処理には適しているかもしれませんが、コメントの削除や CSS ルールの縮小化など、その他のコンテンツ別のさまざまな最適化は認識していません。前処理、縮小化、コンテキストに対応した最適化はこのような強力なツールになる可能性があるのはこのためです。

Note: 良い例があります。JQuery ライブラリの圧縮前の開発バージョンは今や 300 KB になる勢いです。同じライブラリでも縮小化版（コメントなどを削除したもの）は約 1/3 の大きさで、100 KB 程度です。

同様に、上記の技術は単なるテキストベースのアセット以外にも応用できます。画像、動画などの種類のコンテンツにはすべて、独自の形式のメタデータや各種のペイロードが含まれています。たとえば、カメラで写真を取るたびに、通常、写真にはカメラの設定、場所といった余分な多くの情報が埋め込まれます。アプリケーションによって、このデータが重要になる（写真共有サイトなど）場合もあれば、まったく逆の場合もあります。削除した方がよいかどうかを検討することが必要です。実際、このメタデータがあると、画像ごとに最大数十キロバイト加算される可能性があります。

要するに、アセットの効率性を最適化する最初の手順は、さまざまなコンテンツの種類の一覧を作成し、どのような種類のコンテンツ別の最適化を適用すればサイズを縮小できるかを検討することです。こうすることで、容量を大幅に削減できます。何が最適化になるかを判断したら、次に、その最適化をビルドとリリースのプロセスに追加して自動化します。これが、最適化を確実に実施できる唯一の方法です。

## GZIP によるテキストの圧縮

### TL;DR {: .hide-from-toc }
- GZIP はテキストベースのアセット（CSS、JavaScript、HTML）に対して実行することが推奨される
- 最新のブラウザはすべて GZIP 圧縮に対応し、自動的にこの圧縮をリクエストする
- サーバーを GZIP 圧縮に対応するように設定する必要がある
- 一部の CDN は GZIP に対応していることに特に注意して確認する必要がある


[GZIP](http://en.wikipedia.org/wiki/Gzip) はどのようなバイトストリームにも適用できる汎用の圧縮ツールです。内部で GZIP は以前表示されたコンテンツの一部を記憶し、重複するデータ フラグメントを効率よく検索して置換することを試みます。関心があれば、[詳しい GZIP の説明をご確認ください](https://www.youtube.com/watch?v=whGwm0Lky2s&feature=youtu.be&t=14m11s)。ただし、実際のところ、GZIP で最適なパフォーマンスが得られるのはテキストベースのコンテンツで、大きいファイルでは圧縮率は 70～90% になりますが、別のアルゴリズムで既に圧縮されているアセットで GZIP を実行しても、ほとんどまたはまったく改善は見られません。

最新のブラウザはすべて GZIP 圧縮に対応し、すべての HTTP リクエストで GZIP 圧縮のネゴシエーションが自動的に実施されます。ここで必要なことは、クライアントからリクエストされたときに圧縮後のリソースを提供するようにサーバーが正しく設定されていることを確認することです。


<table>
<thead>
  <tr>
    <th>ライブラリ</th>
    <th>サイズ</th>
    <th>圧縮後のサイズ</th>
    <th>圧縮率</th>
  </tr>
</thead>
<tbody>
<tr>
  <td data-th="ライブラリ">jquery-1.11.0.js</td>
  <td data-th="サイズ">276 KB</td>
  <td data-th="圧縮後">82 KB</td>
  <td data-th="圧縮率">70%</td>
</tr>
<tr>
  <td data-th="ライブラリ">jquery-1.11.0.min.js</td>
  <td data-th="サイズ">94 KB</td>
  <td data-th="圧縮後">33 KB</td>
  <td data-th="圧縮率">65%</td>
</tr>
<tr>
  <td data-th="ライブラリ">angular-1.2.15.js</td>
  <td data-th="サイズ">729 KB</td>
  <td data-th="圧縮後">182 KB</td>
  <td data-th="圧縮率">75%</td>
</tr>
<tr>
  <td data-th="ライブラリ">angular-1.2.15.min.js</td>
  <td data-th="サイズ">101 KB</td>
  <td data-th="圧縮後">37 KB</td>
  <td data-th="圧縮率">63%</td>
</tr>
<tr>
  <td data-th="ライブラリ">bootstrap-3.1.1.css</td>
  <td data-th="サイズ">118 KB</td>
  <td data-th="圧縮後">18 KB</td>
  <td data-th="圧縮率">85%</td>
</tr>
<tr>
  <td data-th="ライブラリ">bootstrap-3.1.1.min.css</td>
  <td data-th="サイズ">98 KB</td>
  <td data-th="圧縮後">17 KB</td>
  <td data-th="圧縮率">83%</td>
</tr>
<tr>
  <td data-th="ライブラリ">foundation-5.css</td>
  <td data-th="サイズ">186 KB</td>
  <td data-th="圧縮後">22 KB</td>
  <td data-th="圧縮率">88%</td>
</tr>
<tr>
  <td data-th="ライブラリ">foundation-5.min.css</td>
  <td data-th="サイズ">146 KB</td>
  <td data-th="圧縮後">18 KB</td>
  <td data-th="圧縮率">88%</td>
</tr>
</tbody>
</table>

上記の表は、人気がある JavaScript ライブラリと CSS フレームワークに GZIP を適用した場合の圧縮率を示したものです。圧縮率の範囲は 60～88% です。縮小化されたファイル（ファイル名に「.min」があるファイル）に GZIP を適用すると圧縮率がさらに向上することがわかります。

1. **最初にコンテンツ別の最適化を適用する: CSS、JS、HTML の縮小化ツール。**
2. **GZIP を適用して縮小化後の出力を圧縮する。**

一番大切な点は、GZIP 対応であることが、実装する最もシンプルで最も見返りのある最適化の 1 つだ、ということです。残念ながら、多くの人が GZIP の実装を忘れています。ほとんどのウェブサーバーは自動的にコンテンツを圧縮してくれるので、あとは、GZIP 圧縮が有効なすべての種類のコンテンツを圧縮するようにサーバーが正しく設定されていることを確認することだけです。

サーバーにとって最適な設定とはどのようなものでしょうか。HTML5 Boilerplate プロジェクトに、人気の高いすべてのサーバーに対応する[サンプル構成ファイル](https://github.com/h5bp/server-configs)が含まれ、構成フラグと設定ごとに詳しいコメントが記載されています。リストでお気に入りのサーバーを見つけたら、GZIP セクションで探して、推奨されている設定でサーバーが設定されていることをご確認ください。

<img src="images/transfer-vs-actual-size.png" class="center" alt="実サイズと転送サイズの DevTools のデモ">

GZIP の動作は、Chrome DevTools を起動して [Network] パネルの [Size] と [Content] 列を調べれば簡単に確認できます。[Size] はアセットの転送サイズを示し、[Content] はアセットの圧縮前のサイズを示しています。上記の例の HTML アセットでは、GZIP により転送時に 24.8 KB 削減されます。

Note: 信じられないかもしれませんが、GZIP を使用するとアセットのサイズが拡大する可能性があるケースもあります。通常、これが発生するのは、アセットが非常に小さく、GZIP ディクショナリのオーバーヘッドが圧縮による削減よりも高くなる場合や、リソースが既に十分に圧縮されている場合です。一部のサーバーでは、「ファイルサイズの下限しきい値」を指定してこの問題を回避できます。

最後にアドバイスを 1 つ。ほとんどのサーバーはユーザーにアセットを提供する際に自動的にそのアセットを圧縮してくれますが、一部の CDN では、GZIP アセットが提供されていることを手動で確認する必要があるため特にご注意ください。サイトを監査し、アセットが実際に[圧縮されている](http://www.whatsmyip.org/http-compression-test/)ことを確認してください。






project_path: /web/fundamentals/_project.yaml
book_path: /web/fundamentals/_book.yaml
description: Поиск и исправление смешанного контента - важная задача, но она может занимать много времени. В этом руководстве обсуждаются некоторые инструменты, которые могут помочь с процессом.

{# wf_published_on: 2015-09-28 #} {# wf_updated_on: 2019-12-10 #} {#
wf_blink_components: Blink>SecurityFeature #}

# Предотвращение смешанного содержимого {: .page-title }

{% include "web/_shared/contributors/johyphenel.html" %}

Успех: поддержка HTTPS для вашего сайта - важный шаг к защите вашего сайта и
ваших пользователей от атак, но смешанный контент может сделать эту защиту
бесполезной. Чтобы защитить ваш сайт и ваших пользователей, очень важно найти и
исправить проблемы связанные со смешанным контентом.

Поиск и исправление смешанного контента - важная задача, но она может занимать
много времени. В этом руководстве обсуждаются некоторые инструменты и методы,
которые могут помочь в этом процессе. Для получения дополнительной информации о
самом смешанном контенте см. [Что такое смешанный
контент](./what-is-mixed-content) .

### TL; DR {: .hide-from-toc }

- Всегда используйте https: // URL при загрузке ресурсов на вашей странице.
- Используйте заголовок `Content-Security-Policy-Report-Only` для мониторинга
ошибок смешанного содержимого на вашем сайте.
- Используйте директиву CSP `upgrade-insecure-requests` reports для защиты ваших
посетителей от небезопасного контента.

## Найти и исправить смешанный контент

Поиск смешанного контента вручную может занять много времени, в зависимости от
количества проблем. Процесс, описанный в этом документе, использует браузер
Chrome; однако большинство современных браузеров предоставляют подобные
инструменты, чтобы помочь с этим процессом.

### Поиск смешанного контента посещая сайт

При посещении страницы HTTPS в Google Chrome браузер предупреждает вас о
смешанном контенте в виде ошибок и предупреждений в консоли JavaScript.

Чтобы просмотреть эти оповещения, перейдите на нашу страницу образцов пассивного
смешанного контента или активного смешанного контента и откройте JavaScript
консоль в Chrome. Вы можете открыть консоль либо из меню «Вид»: *«Вид»* ->
*«Разработчик»* -> *«Консоль JavaScript»*, либо щелкнув правой кнопкой мыши
страницу, выбрав *«Проверка элемента»*, а затем выбрав *«Консоль»* .

Страница [примера пассивного смешанного
содержимого](https://googlesamples.github.io/web-fundamentals/fundamentals/security/prevent-mixed-content/passive-mixed-content.html)
{: .external} в статье [Что такое смешанное
содержимое](what-is-mixed-content#passive-mixed-content){: .external} приводит к
отображению предупреждений о смешанном содержимом, как показано ниже:

<figure> <img src="imgs/passive-mixed-content-warnings.png" alt="Mixed Content:
The page was loaded over HTTPS, but requested an insecure video. This content
should also be served over HTTPS."> </figure> [Try
it](https://googlesamples.github.io/web-fundamentals/fundamentals/security/prevent-mixed-content/passive-mixed-content.html){:
target="_blank" .external }   В то время как пример активного смешанного
содержимого приводит к отображению ошибок смешанного содержимого: <figure> <img
src="imgs/active-mixed-content-errors.png" alt="Mixed Content: The page was
loaded over HTTPS, but requested an insecure resource. This request has been
blocked; the content must be served over HTTPS."> </figure> [Try
it](https://googlesamples.github.io/web-fundamentals/fundamentals/security/prevent-mixed-content/active-mixed-content.html){:
target="_blank" .external }   Вам необходимо исправить http:// URLы из этого
списка ошибок и предупреждений в исходном коде вашего сайта. Полезно составить
список этих URL-адресов вместе со страницей, на которой вы их нашли, чтобы
использовать его при их исправлении. Note: Ошибки и предупреждения о смешанном
содержимом показываются только для страницы, которую вы сейчас просматриваете, и
JavaScript консоль очищается каждый раз когда вы переходите на новую страницу.
Это означает что вы должны просмотреть каждую страницу вашего сайта отдельно,
чтобы найти эти ошибки. Некоторые ошибки могут показаться только после
взаимодействия с какой-либо частью страницы, например вы можете посмотреть
пример с галереей из предыдущего руководства. ### Поиск смешанного содержимого в
вашем исходном коде Вы можете искать смешанное содержимое напрямую в исходном
коде. Ищите `http://` в вашем исходном коде и смотрите на тэги, которые включают
HTTP URL атрибуты. Особенно обращайте внимание на тэги из списка в разделе [типы
смешанного содержимого и связанные угрозы
безопасности](what-is-mixed-content#mixed-content-types--security-threats-associated){:
.external} из предыдущего руководства. Обратите внимание, что наличие `http: //`
в атрибуте `href` тегов ссылки (` <a> `) часто не является проблемой смешанного
содержимого, за некоторыми заметными исключениями, которые будут обсуждаться
позже. Если у вас есть список HTTP URLов из ошибок и предупреждений Chrome, вы
можете также найти эти полные URLы в вашем исходном коде и определить где они
включаются в ваш сайт. ### Исправление смешанного содержимого Как только вы
нашли где смешанное содержимое добавляется в исходном коде, следуйте этими
шагами чтобы исправить его. Используйте эту ошибку смешанного содержимого как
пример: <figure> <img src="imgs/image-gallery-warning.png" alt="Mixed Content:
The page was loaded over HTTPS, but requested an insecure image. This content
should also be served over HTTPS."> </figure> Который вы нашли в исходниках
здесь: <img src="http://googlesamples.github.io/web-fundamentals/.../puppy.jpg">
#### Шаг 1 Проверьте что URL доступен по HTTPS, открыв его в новой вкладке
вашего браузера, введя URL в адресной строке, и поменяв `http://` на `https://`.
Если ресурс отображается одинаково и по **HTTP** и по **HTTPS** - всё OK.
Переходите к [Шагу 2](#step-2). <div class="attempt-left">   <figure>     <img
src="imgs/puppy-http.png">     <figcaption class="success">       HTTP
изображение загружается без ошибок.      </figcaption>   </figure> </div> <div
class="attempt-right">   <figure>     <img src="imgs/puppy-https.png">
<figcaption class="success">       HTTPS изображение загружается без ошибок и
оно такое же как и по HTTP. Переходим к <a href="#step-2">шагу 2</a>!
</figcaption>   </figure> </div> <div style="clear:both;"></div> Если вы видите
предупреждение о сертификате, или если содержимое не может быть отображено по
**HTTPS**, это означает что ресурс не  доступен безопасно. <div
class="attempt-left">   <figure>     <img src="imgs/https-not-available.png">
<figcaption class="warning">       Ресурс не доступен по HTTPS.
</figcaption>   </figure> </div> <div class="attempt-right">   <figure>     <img
src="imgs/https-cert-warning.png">     <figcaption class="warning">
Предупреждение о сертификате при попытке посмотреть ресурс по HTTPS.
</figcaption>   </figure> </div> <div style="clear:both;"></div> В этом случае
вы должны рассмотреть одну из следующих опций: * Включить ресурс с другого
хоста, если таковой имеется. * Загрузить и разместить контент на вашем сайте
напрямую, если вам это разрешено по закону. * Исключить ресурс из вашего сайта в
целом. #### Шаг 2 Измените URL с `http: //` на `https: //`, сохраните исходный
файл и при необходимости повторно загрузите на сервер обновленный файл. #### Шаг
3 Просмотрите страницу, где вы изначально обнаружили ошибку, и убедитесь, что
ошибка больше не появляется. ### Остерегайтесь нестандартного использования
тегов Остерегайтесь нестандартного использования тегов на вашем сайте. Например,
URLы в ссылке (`</a><a>`) не вызывают ошибок смешанного содержимого сами по
себе, поскольку они заставляют браузер переходить на новую страницу. Это
означает, что они обычно не должны быть исправлены. Однако некоторые скрипты
гаререй изображений переопределяют функционал ссылки `</a><a>` и загружают HTTP
ресурсы, описанные в атрибуте `href` в отображение лайтбокса (lightbox) на
странице, вызывая проблему смешанного содержимого. <pre class="prettyprint"> {%
includecode
content_path="web/fundamentals/security/prevent-mixed-content/_code/image-gallery-example.html"
region_tag="snippet1" adjust_indentation="auto" %} </pre> </a>

[Попробуй
это](https://googlesamples.github.io/web-fundamentals/fundamentals/security/prevent-mixed-content/image-gallery-example.html)
{: target="_blank" .external }

В приведенном выше коде, может показаться безопасно оставить атрибут `href` тэга
`<a>` как `http://`; однако, если вы посмотрите образец и нажмете на
изображение, вы увидите, что он загружает смешанный ресурс контента и отображает
его на странице.

## Массовая обработка смешанного содержимого

Шаги, описанные выше, хорошо подходят для небольших сайтов; но для крупных
веб-сайтов или сайтов с множеством отдельных групп разработчиков может быть
сложно отслеживать весь загружаемый контент. Чтобы справиться с этой задачей, вы
можете использовать политику безопасности содержимого, чтобы дать браузеру
указание уведомлять вас о смешанном содержимом и гарантировать, что ваши
страницы никогда не будут неожиданно загружать небезопасные ресурсы.

### Политика безопасности контента

[**Политика безопасности контента**](/web/fundamentals/security/csp/) (Content
Security Policy - CSP) - это многоцелевая функция браузера, которую можно
использовать для массового управления смешанным контентом. Механизм отчетов CSP
может использоваться для отслеживания смешанного контента на вашем сайте; и
политика защиты, чтобы защитить пользователей путем обновления или блокировки
смешанного контента.

Вы можете включить эти функции для страницы, включив заголовок
`Content-Security-Policy` или `Content-Security-Policy-Report-Only` в ответ,
отправленный с вашего сервера. Кроме того, вы можете установить
`Content-Security-Policy` (но **не** `Content-Security-Policy-Report-Only` ),
используя `<meta>` в разделе `<head>` вашей страницы. Смотрите примеры в
следующих разделах.

CSP полезен для многих вещей за пределами смешанного контента. Информация о
других директивах CSP доступна на следующих ресурсах:

- [Введение CSP от
Mozilla](https://developer.mozilla.org/en-US/docs/Web/Security/CSP/Introducing_Content_Security_Policy)
{: .external}
- [Введение CSP от HTML5
Rocks](//www.html5rocks.com/en/tutorials/security/content-security-policy/) {:
.external}
- [CSP песочница](http://www.cspplayground.com/) {: .external }
- [CSP спецификация](//www.w3.org/TR/CSP/) {: .external }

Note: Браузеры применяют <b>все</b> политики безопасности содержимого, которые
они получают. Несколько значений CSP заголовка, полученного браузером в
заголовке ответа или элементах <code><meta data-md-type="raw_html"></code>
объединяются в единую политику; Политики отчетности также комбинируются.
Политики объединяются путем пересечения политик; то есть каждая политика после
первой может только ограничивать разрешенный контент, а не расширять его.

### Поиск смешанного контента с политикой безопасности контента

Вы можете использовать политику безопасности контента для сбора отчетов о
смешанном контенте на вашем сайте. Чтобы включить эту функцию, установите
директиву `Content-Security-Policy-Report-Only` , добавив ее в качестве
заголовка ответа для вашего сайта.

Заголовок ответа:

```
Content-Security-Policy-Report-Only: default-src https: 'unsafe-inline' 'unsafe-eval'; report-uri https://example.com/reportingEndpoint
```

Каждый раз, когда пользователь посещает страницу на вашем сайте, его браузер
отправляет отчеты в формате JSON, касающиеся всего, что нарушает политику
безопасности контента, на `https://example.com/reportingEndpoint` . В этом
случае каждый раз, когда подресурс загружается по HTTP, отправляется отчет. Эти
отчеты включают URL-адрес страницы, где произошло нарушение политики, и
URL-адрес подресурса, который нарушил политику. Если вы настроите свою конечную
точку отчетности для регистрации этих отчетов, вы можете отслеживать смешанный
контент на своем сайте, не посещая каждую страницу самостоятельно.

Два предостережения:

- Пользователи должны посетить вашу страницу в браузере, который понимает
заголовок CSP. Это верно для большинства современных браузеров.
- Вы получаете отчеты только для страниц, посещенных вашими пользователями. Так
что если у вас есть страницы, которые не получают много трафика, может пройти
некоторое время, прежде чем вы получите отчеты по всему сайту.

Дополнительные сведения о формате заголовка CSP см. в [спецификации политики
безопасности
содержимого](https://w3c.github.io/webappsec/specs/content-security-policy/#violation-reports)
{: .external}.

Если вы не хотите настроить конечную точку отчетности самостоятельно,
[https://report-uri.io/](https://report-uri.io/) {: .external} является разумной
альтернативой.

### Обновление небезопасных запросов

Одним из новейших и лучших инструментов для автоматического исправления
смешанного контента является директива CSP
[**`upgrade-insecure-requests`**](//www.w3.org/TR/upgrade-insecure-requests/) {:
.external}. Эта директива указывает браузеру обновить небезопасные URL-адреса
перед выполнением сетевых запросов.

Например, если страница содержит тег изображения с URL-адресом HTTP:

```
<img src="http://example.com/image.jpg">
```

Браузер вместо этого сделает безопасный запрос <code><b
data-md-type="raw_html">https:</b>//example.com/image.jpg</code>, что обезопасит
пользователя от смешанного содержимого.

Вы можете включить это поведение, отправив заголовок `Content-Security-Policy` с
этой директивой:

```
Content-Security-Policy: upgrade-insecure-requests
```

Или путем встраивания той же самой директивы inline в раздел `<head>` документа
с использованием элемента `<meta>` :

```
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
```

Стоит отметить, что если ресурс недоступен по HTTPS, обновленный запрос
завершается неудачно и ресурс не загружается. Это поддерживает безопасность
вашей страницы.

Директива `upgrade-insecure-requests` каскадно переходит в документы `<iframe>`
, обеспечивая защиту всей страницы.

### Блокировка всего смешанного контента

Не все браузеры поддерживают директиву `upgrade-insecure-requests`, поэтому
альтернативой защиты пользователей является директива CSP
[**`block-all-mixed-content`**](http://www.w3.org/TR/mixed-content/#strict-checking)
{: .external}. Эта директива указывает браузеру никогда не загружать смешанный
контент; все запросы ресурсов смешанного контента блокируются, включая как
активный, так и пассивный смешанный контент. Этот параметр также
распространяется на документы `<iframe>`, гарантируя, что вся страница не будет
смешанной.

Страница может присоединиться к этому поведению, отправив заголовок
`Content-Security-Policy` с этой директивой:

```
Content-Security-Policy: block-all-mixed-content
```

Или путем встраивания той же самой директивы inline в раздел `<head>` документа
с использованием элемента `<meta>` :

```
<meta http-equiv="Content-Security-Policy" content="block-all-mixed-content">
```

Недостатком использования `block-all-mixed-content` является то, что, пожалуй,
очевидно, что весь контент заблокирован. Это улучшение безопасности, но это
означает, что эти ресурсы больше не доступны на странице. Это может поломать
функции и содержимое, которое  должно быть доступным, как ожидают ваши
пользователи.

### Альтернативы CSP

Если ваш сайт размещен вами на такой платформе, как Blogger, у вас может быть не
доступа функция изменения заголовков и добавления CSP. Вместо этого
жизнеспособной альтернативой может быть использование сканера веб-сайтов для
поиска проблем на вашем сайте, таких как
[HTTPSChecker](https://httpschecker.net/how-it-works#httpsChecker) {: .external
} или [Сканер смешанного
содержимого](https://github.com/bramus/mixed-content-scan) {: .external }.

## Обратная связь {: #feedback }

{% include "web/_shared/helpful.html" %}   Translated by {% include
"web/_shared/contributors/dmitryskripunov.html" %}

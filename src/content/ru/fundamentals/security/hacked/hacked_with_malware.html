<html devsite><head>
  <title>Сайт взломан и распространяет вредоносное ПО</title>
  <meta name="project_path" value="/web/fundamentals/_project.yaml"/>
  <meta name="book_path" value="/web/fundamentals/_book.yaml"/>
</head>
  <body>
<p>Данные инструкции предназначены для тех, чьи сайты были взломаны с целью распространения вредоносного ПО. Как правило, такие ресурсы отображаются в результатах поиска с пометкой <em>Этот сайт может нанести вред вашему компьютеру</em>. Это один из самых длительных этапов восстановления,  поскольку вам придется найти все поврежденные файлы на своем сайте и составить их список.
  Он пригодится вам на следующем этапе: <a href="clean_site">устранение уязвимостей и обеспечение защиты сайта</a>.</p>
  <p>Если в результатах поиска ваши страницы отображаются с предупреждением <em>Возможно, этот сайт был взломан</em>, значит хакер распространяет спам, а не вредоносное ПО. В таком случае следуйте <a href="hacked_with_spam">этим инструкциям</a>.</p>

    <div class="video-wrapper">
      <iframe class="devsite-embedded-youtube-video" data-video-id="Snt45fZQIiU" data-autohide="1" data-showinfo="0" frameborder="0" allowfullscreen>
      </iframe>
    </div>

<h3>Необходимые условия</h3>
<ul>
  <li>Доступ к серверу сайта (веб-серверу, базе данных и файловой системе) через терминал или оболочку с правами администратора.</li>
  <li>Знание команд оболочки или терминала.</li>
  <li>Возможность выполнять SQL-запросы в базе данных.</li>
</ul>
<h3>Дальнейшие действия</h3>

<div class="action">
<p>Этот шаг состоит из трех этапов:</p>
<ul>
  <li><a href="#preparation">Подготовка</a></li>
  <li><a href="#investigation">Определение типов вредоносного ПО на вашем сайте</a></li>
  <li><a href="#assessment">Оценка масштаба изменений в файловой системе</a></li>
</ul>
</div>

<a name="preparation"></a>
<h3>Подготовьтесь</h3>
<ol>
  <li>Ни в коем случае не открывайте страницы своего сайта в браузере. Поступая так, вы подвергаете свой компьютер риску, поскольку вредоносное ПО зачастую использует именно уязвимости браузеров.</li>
  <li>Создайте журнал расследования (обычный текстовый документ) и записывайте в него всю информацию, обнаруженную на этом шаге. Как минимум, вам необходимо записать названия всех измененных хакером файлов, путь к ним и тип атаки. Эти данные помогут вам <a href="clean_site">устранить уязвимости и выработать стратегию защиты сайта</a>.</li>
  <li>Рекомендуем ознакомиться с дополнительными материалами:
    <ul>
      <li>Посмотрите видео о принципах работы вредоносного ПО и узнайте, как обезопасить свой компьютер во время расследования.</li>
      <li>С помощью нашей <a href="/safe-browsing/">страницы диагностики</a> проверьте, может ли ваш сайт нанести вред устройствам посетителей. Статус своего сайта можно узнать по ссылке в формате:
      <pre>http://www.google.com/safebrowsing/diagnostic?site=&lt;your-site&gt;</pre>
      Например: <code>http://www.google.com/safebrowsing/diagnostic?site=webmastercentralblog.blogspot.com</code></li>
    </ul>
  </li>
  <li>Используйте <a href="https://www.google.com/search?q=cURL">cURL</a> или <a href="https://www.google.com/search?q=Wget">Wget</a> для отправки HTTP-запросов (например, для загрузки страниц).
    <p>Эти бесплатные инструменты помогают диагностировать переадресацию и позволяют указывать любые URL перехода, а также сочетания браузера и ОС (параметр user-agent). Меняя эти значения, можно лучше выяснить принципы работы вредоносного ПО, поскольку хакеры часто распространяют его только для пользователей определенных платформ или посетителей с заданных ресурсов, чтобы избегать обнаружения со стороны владельцев сайтов или сканеров уязвимостей.</p>
    <pre>$curl -v --referer "http://www.google.com" &lt;your-url&gt;</pre></li>
</ol>

<a name="investigation"></a>
<h3>Определите, какое вредоносное ПО используется на вашем сайте</h3>
<ol>
  <li>Откройте Search Console, выберите свой подтвержденный сайт и перейдите в раздел <strong>Проблемы безопасности</strong>.</li>
  <li> Проверьте страницы сайта на наличие вредоносного ПО любой категории (например, которое изменяет конфигурацию сервера, внедряется с помощью запроса SQL и т. д.). Нажмите "Подробности" в интересующей вас категории, чтобы узнать больше о взломанных URL. Вы можете увидеть, например, фрагменты кода, внедренные хакером. По каждой категории скопируйте в журнал расследования:
    <ul>
      <li>URL всех измененных хакером страниц, которые значатся в этой категории на странице "Проблемы с безопасностью";</li>
      <li>адреса всех остальных измененных хакером страниц, которые вы обнаружите в процессе расследования;</li>
      <li>дополнительные данные по взломанным страницам, например тип вредоносного ПО.</li>
    </ul>
  </li>
  <li>Выявить разные типы вредоносного ПО вам помогут следующие статьи:
    <ul>
      <li><a href="https://www.support.google.com/webmasters/answer/3024318">Конфигурация сервера</a></li>
      <li><a href="https://www.support.google.com/webmasters/answer/3024309">Внедрение с помощью запроса SQL</a></li>
      <li><a href="https://www.support.google.com/webmasters/answer/3024381">Шаблон ошибки</a></li>
      <li><a href="https://www.support.google.com/webmasters/answer/3024344">Внедрение кода</a></li>
    </ul>
  </li>
</ol>

<a name="assessment"></a>
<h4>Оцените масштаб изменений в файловой системе</h4>
        <div class="video-wrapper">
      <iframe class="devsite-embedded-youtube-video" data-video-id="2A4dLkXXUjo" data-autohide="1" data-showinfo="0" frameborder="0" allowfullscreen>
      </iframe>
    </div>

<p>Теперь необходимо войти на сервер сайта, чтобы оценить масштаб изменений в файловой системе для лучшего понимания ситуации. Помните: хакер мог изменить существующие страницы или записи в базах данных, создать абсолютно новые страницы со спамом, внедрить функции, показывающие спам на неизмененных страницах, или оставить лазейки, позволяющие возвращаться на сайт либо продолжающие наносить ущерб.</p>
<p>Если ваш сайт ещё не отключен, приостановите его работу на время выполнения этого шага.</p>
<ol>
  <li>Если у вас есть чистая резервная копия сайта, сравните файлы, чтобы узнать, какие из них были созданы или удалены с момента резервного копирования. Запишите обнаруженные файлы в журнал расследования, чтобы вернуться к ним на следующих этапах. В Unix-подобных системах для сравнения каталогов используйте эту команду:
  <pre>$ diff -qr &lt;current-directory&gt; &lt;backup-directory&gt;</pre>
  Пример:
  <pre>$ diff -qr www/ backups/full-backup-20120124/</pre>
  Для сравнения файлов используйте команду:
  <pre>$ md5sum &lt;current-page&gt; &lt;backup-page&gt;</pre>
  Пример:
  <pre>$ md5sum www/page.html backups/full-backup-20120124/page.html</pre></li>
  <li>Проверьте <strong>журналы ошибок, сервера и доступа</strong> на предмет подозрительных действий, например неудачных попыток входа, выполнения команд (особенно от имени пользователя root), создания аккаунтов для неизвестных пользователей и т. д. Помните, что хакеры могли замести следы, изменив журналы. Некоторые примеры обсуждаются в <a href="vulnerability">видеоролике о поиске уязвимости</a>.</li>
  <li>Проверьте <strong>файлы настроек</strong>, например .htaccess и httpd.conf на предмет переадресаций.
    Хакеры часто настраивают переадресацию в зависимости от операционной системы и браузера, времени суток или страницы, с которой перешел пользователь.</li>
  <li>Проверьте уровень разрешений для файлов и папок. Помните, что хакеры часто меняют разрешения, оставляя себе лазейку для возврата на сайт. Файлы с разрешением выше 644 (rw-r--r--) и папки, у которых оно больше 755 (rwxr-xr-x), представляют угрозу безопасности. Понизьте для них уровень доступа, если в нем нет крайней необходимости. Чтобы найти излишне открытые файлы и папки, в Unix-подобных системах используйте эту команду:
  <pre>$ find &lt;your-dir&gt; -type d -not -perm 755 -exec ls -ld {} \;</pre>
  <pre>$ find &lt;your-dir&gt; -type f -not -perm 644 -exec ls -la {} \;</pre></li>
  <li>Если на вашем сайте используется база данных, проверьте все записи с помощью <a href="https://www.phpmyadmin.net/home_page/index.php">phpMyAdmin</a> или аналогичного инструмента.</li>
</ol>

<h2>Следующий этап</h2>
<p>Далее необходимо <a href="vulnerability">найти уязвимость</a>.</p>

</body></html>

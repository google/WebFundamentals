project_path: /web/_project.yaml
book_path: /web/fundamentals/_book.yaml
description: Удалив все ненужные ресурсы, перейдем к следующем шагу - уменьшению размера оставшихся скачиваемых данных, то есть к сжатию с помощью базовых и специфических алгоритмов GZip.

{# wf_updated_on: 2014-09-11 #}
{# wf_published_on: 2014-03-31 #}

# Оптимизация кодировки и размера передаваемых текстовых ресурсов {: .page-title }

{% include "web/_shared/contributors/ilyagrigorik.html" %}



У веб-приложений становится все больше возможностей, задач и функций. Однако чем разнообразнее контент, тем больше данных приходится скачивать. Чтобы производительность приложений всегда оставалась высокой, нам нужно оптимизировать каждый байт данных.



;##

Удалив все ненужные ресурсы, перейдем к следующем шагу - уменьшению размера оставшихся скачиваемых данных, то есть к сжатию. В зависимости от типа ресурса (текста, изображения, шрифта и т. д.) мы можем применить разные методы: воспользоваться стандартными инструментами на сервере, оптимизировать конкретный тип данных во время предварительной обработки или уменьшить размер данных самостоятельно.

Чтобы добиться лучших результатов, необходимо совмещать все эти техники.

### TL;DR {: .hide-from-toc }
- Сжатие - это процесс кодировки информации с помощью меньшего количества битов.
- Удаление ненужных данных всегда приносит лучший результат.
- Существует множество разных техник и алгоритмов сжатия.
- Чтобы добиться максимального сжатия, вам нужно импользовать несколько методов.


Сжатие данных - это процесс уменьшения их размера. Многие специалисты всю жизнь занимались исследованиями в этой области. Они работали над алгоритмами, техниками и методами оптимизации, улучшая коэффициент сжатия, скорость и системные требований различных компрессоров. Конечно, мы не собираемся подробно рассматривать всю тему, но важно в общих чертах понимать, как работает оптимизация и какие методы нам доступны для уменьшения размера ресурсов на страницах.

Чтобы показать ключевые принципы работы этих техник, рассмотрим, как можно оптимизировать простое текстовое сообщение.

    # Внизу секретное сообщение, состоящее из наборов заголовков.
    # После формата `ключ-значение` идет перевод строки и зашифрованное сообщение.
    format: secret-cipher
    date: 04/04/14
    AAAZZBBBBEEEMMM EEETTTAAA

1. В сообщениях могут содержаться комментарии, отмеченные префиксом #. Они не влияют на суть или отображение информации.
2. В начале сообщений могут содержаться `заголовки`, то есть пары `ключ-значение`, отделенные символом `:`.
3. В сообщениях могут содержаться полезные данные.

Как уменьшить размер сообщения выше, в котором сейчас 200 символов?

1. Конечно, комментарий интересен, но он не влияет на суть сообщения, поэтому мы можем удалить его при передаче информации.
2. Существуют эффективные методы для кодирования заголовков. В данном случае мы не знаем, все ли сообщения имеют заголовки format и date. Если это так, мы просто можем присвоить им короткие идентификаторы, использующиеся при передаче. Однако мы не уверены в этом, поэтому оставим все как есть.
3. Полезные данные - это просто текст, и хотя мы не знаем, что на самом деле он значит (очевидно, это `секретное сообщение``), можно заметить, что в нем много лишних символов. Например, вместо отправки повторяющихся букв, мы можем просто указать их количество и создать более эффективный код.
    * Например, `ААА` становится `3А`, или последовательностью из трех А.


Сочетая несколько методов, мы получили следующий результат:

    format: secret-cipher
    date: 04/04/14
    3A2Z4B3E3M 3E3T3A

В новом сообщении всего 56 символов. Нам удалось сжать исходную информацию на целых 72%, и это только начало.

Но как это поможет оптимизировать сайт? Неужели нам придется изобретать собственные алгоритмы сжатия? Конечно, нет. Но мы будем использовать те же техники и методы, как и при оптимизации различных ресурсов на страницах: предварительную обработку, оптимизацию на основе контекста и особые алгоритмы для определенных типов контента.


## Минификация: предварительная обработка и оптимизация на основе контекста

### TL;DR {: .hide-from-toc }
- Чтобы значительно уменьшить размер скачиваемых ресурсов, используйте методы оптимизации для определенного типа контента.
- Включите методы оптимизации для отдельных типов контента в процесс сборки приложения.


Лучший способ сжать избыточные или ненужные данные - это удалить их. Конечно, мы не можем просто так стирать информацию, но в некоторых случаях, зная о формате данных и его свойствах, всегда можно значительно снизить размер ресурса, не меняя его суть.

<pre class="prettyprint">
{% includecode content_path="web/fundamentals/performance/optimizing-content-efficiency/_code/minify.html" region_tag="full" adjust_indentation="auto" %}
</pre>

Посмотрите на простую HTML-страницу сверху и на три типа контента, которые в ней содержатся: HTML-разметка, CSS-стили и JavaScript. Для всех этих типов есть разные правила написания, обозначения комментариев и т. д. Как уменьшить размер такой страницы? 

* •	Комментарии в коде помогают разработчику, но совершенно не нужны в браузере. Просто удалите комментарии CSS (`/* ... */`), HTML (`<!-- ... -->`) и JavaScript (`// ...`), и размер файла значительно уменьшится.
* Продвинутый CSS-компрессор может заметить, что мы используем неэффективный способ определения правила для .awesome-container. Он объединит два объявления в одно без изменения других стилей и сэкономит ещё больше байтов.
* Пробелы и табуляция нужны только для удобства разработчика. Дополнительный компрессор может удалить их.

^
<pre class="prettyprint">
{% includecode content_path="web/fundamentals/performance/optimizing-content-efficiency/_code/minified.html" region_tag="full" adjust_indentation="auto" %}
</pre>

После применения этих шагов страница уменьшилась с 406 до 150 символов. Мы сэкономили целых 63%! Конечно, теперь прочитать код непросто, но это и не нужно. Мы можем сохранить оригинальную страницу в качестве версии для разработчика и применить описанные выше шаги, когда мы захотим опубликовать ее на сайте.

Из примера выше мы можем сделать важный вывод. Универсальный компрессор, например для сжатия комментариев, смог бы уменьшить размер этой страницы, но не удалил бы комментарии, не совместил CSS-правила и не применил другие техники оптимизации. Именно поэтому предварительная обработка/минификация/оптимизация на основе контекста очень важна и может принести высокие результаты.

Note: Несжатая версия библиотеки JQuery для разработчиков весит примерно 300 КБ. После минификации (удаления комментариев и т. д.) ее размер в три раза меньше: около 100 КБ.

Все описанные техники можно применять не только к текстовым, но и к другим ресурсам. Изображения, видео и другие типы контента также содержат метаданные и полезные данные. Например, когда вы делаете фотографию, в файл добавляется информация о настройках камеры, местоположении и т. д. В некоторых приложениях, например на сайте для публикации фотографий, эти данные необходимы. Однако если они не нужны, удалите их, потому что они могут добавить десятки килобайтов к размеру изображения.

Итак, в качестве первого шага оптимизации составьте список разных типов контента и подумайте, какие методы оптимизации можно применить для каждого из них. Затем добавьте эти методы в процесс сборки приложения. Только так вы сможете быть уверены, что оптимизация будет проходить должным образом.

## Сжатие текста с помощью GZIP

### TL;DR {: .hide-from-toc }
- GZIP лучше всего сжимает текстовые ресурсы: CSS, JavaScript и HTML.
- Все современные браузеры поддерживают и автоматически запрашивают сжатие GZIP.
- На сервере должно быть настроено сжатие GZIP.
- В некоторых сетей доставки контента вы должны проверить, включено ли сжатие GZIP.


[GZIP](http://en.wikipedia.org/wiki/Gzip) - это стандартный компрессор, который может быть применен к любому потоку байтов. Он запоминает встреченный ранее контент, а затем находит и заменяет повторяющиеся фрагменты данных. Прочитать подробное описание работы GZIP можно [здесь](https://www.youtube.com/watch?v=whGwm0Lky2s&feature=youtu.be&t=14m11s). GZIP лучше всего сжимает текстовые ресурсы, часто достигая коэффициента сжатия 70-90% при работе с большими файлами. Однако, если вы попытаетесь уменьшить размер ресурсов, уже сжатыхс помощью альтернативных алгоритмов, (например, изображений), не произойдет практически никакого улучшения.

Современные браузеры поддерживают и автоматически применяют сжатие GZIP для всех HTTP-запросов. Вам требуется только убедиться, что на сервере настроена отправка сжатого ресурса по запросу клиента.


<table>
<thead>
  <tr>
    <th>Библиотека</th>
    <th>Размер</th>
    <th>Размер после сжатия</th>
    <th>Коэффициент сжатия</th>
  </tr>
</thead>
<tbody>
<tr>
  <td data-th="библиотека">jquery-1.11.0.js</td>
  <td data-th="размер">276 КБ</td>
  <td data-th="после сжатия">82 КБ</td>
  <td data-th="экономия">70%</td>
</tr>
<tr>
  <td data-th="библиотека">jquery-1.11.0.min.js</td>
  <td data-th="размер">94 КБ</td>
  <td data-th="после сжатия">33 КБ</td>
  <td data-th="экономия">65%</td>
</tr>
<tr>
  <td data-th="библиотека">angular-1.2.15.js</td>
  <td data-th="размер">729 КБ</td>
  <td data-th="после сжатия">182 КБ</td>
  <td data-th="экономия">75%</td>
</tr>
<tr>
  <td data-th="библиотека">angular-1.2.15.min.js</td>
  <td data-th="размер">101 КБ</td>
  <td data-th="после сжатия">37 КБ</td>
  <td data-th="экономия">63%</td>
</tr>
<tr>
  <td data-th="библиотека">bootstrap-3.1.1.css</td>
  <td data-th="размер">118 КБ</td>
  <td data-th="после сжатия">18 КБ</td>
  <td data-th="экономия">85%</td>
</tr>
<tr>
  <td data-th="библиотека">bootstrap-3.1.1.min.css</td>
  <td data-th="размер">98 КБ</td>
  <td data-th="после сжатия">17 КБ</td>
  <td data-th="экономия">83%</td>
</tr>
<tr>
  <td data-th="библиотека">foundation-5.css</td>
  <td data-th="размер">186 КБ</td>
  <td data-th="после сжатия">22 КБ</td>
  <td data-th="экономия">88%</td>
</tr>
<tr>
  <td data-th="библиотека">foundation-5.min.css</td>
  <td data-th="размер">146 KB</td>
  <td data-th="после сжатия">18 КБ</td>
  <td data-th="экономия">88%</td>
</tr>
</tbody>
</table>

В таблице сверху показано, насколько уменьшился размер нескольких популярных библиотек JavaScript и CSS-фреймворков при использовании сжатия GZIP. Коэффициент сжатия составляет от 60 до 88%, а при обработке минифицированных файлов (в названии которых есть .min) он становится ещё выше.

1. **Сначала применяйте методы оптимизации для конкретного контента: CSS-, JS- или HTML-минификаторы.**
2. **Используйте GZIP для сжатия минифицированных файлов.**

Включение GZIP-сжатия - это один из самых простых и эффективных методов оптимизации, о котором многие забывают. Большинство веб-серверов будут уменьшать размер контента самостоятельно. Вам просто надо проверить, настроено ли на сервере сжатие всех типов ресурсов, для которых эффективно применение GZIP.

Какая конфигурация подойдет вашему серверу лучше всего? В проекте HTML5 Boilerplate размещены примеры файлов конфигурации для самых популярных серверов с подробными комментариями для всех параметров и настроек. Найдите в списке нужный сервер, загляните в раздел GZIP и убедитесь, что на вашем сервере установлены рекомендованные настройки.

<img src="images/transfer-vs-actual-size.png" class="center" alt="Сравнение фактического размера ресурса и размера при передаче в Инструментах разработчика">

Чтобы посмотреть результаты работы GZIP, откройте инструменты разработчика в Chrome и найдите столбец `Size/Content` (Размер/контент) на панели `Network` (Сеть). Число `Размер` - это вес передаваемого ресурса, а `контент` - вес несжатого ресурса. Например, GZIP сжал передаваемый HTML-ресурс из примера выше на 24,8 КБ.

Note: В это сложно поверить, но в некоторых случаях GZIP может увеличить размер ресурса. Это происходит, если он весит очень мало и затраты на поддержку словаря GZIP выше, чем экономия от сжатия. Также причина может быть в том, что ресурс уже достаточно сжат. На некоторых серверах можно указать минимальный размер файла, чтобы избежать этой проблемы.

В завершении мы хотим предупредить вас. Большинство серверов автоматически сжимают ресурсы при передаче. Однако при использовании некоторых сетей доставки контента необходимо самостоятельно узнать, отправляется ли пользователю сжатый GZIP-ресурс. Проверьте ваш сайт и убедитесь, что все ресурсы действительно [сжимаются](http://www.whatsmyip.org/http-compression-test/).






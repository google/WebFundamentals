project_path: /web/_project.yaml
book_path: /web/updates/_book.yaml

{# wf_updated_on: 2012-12-23 #}
{# wf_published_on: 2012-12-23 #}
{# wf_tags: news,getusermedia,screenshare,webrtc #}

# Screensharing with WebRTC {: .page-title }

{% include "web/_shared/contributors/samdutton.html" %}


<p><a href="http://updates.html5rocks.com/2012/12/WebRTC-hits-Firefox-Android-and-iOS">As we reported last week</a>, there's been a <strong>lot</strong> happening lately with our old friend <a href="http://www.html5rocks.com/en/tutorials/webrtc/basics/">WebRTC</a>.</p>

<p>Well... here's another first: WebRTC screensharing.</p>

<a href="https://www.youtube.com/watch?v=tD0QtBUZsF4" title="Linked to screencast of WebRTC screensharing in action. Screengrab image shows WebRTC screensharing extension, featuring Jake Archibald, Peter Beverloo, Paul Lewis and Sam Dutton."><img src="/web/updates/images/2012/12/screensharing/rtcshare.jpg" alt="Screengrab of WebRTC screensharing extension, featuring Jake Archibald, Peter Beverloo, Paul Lewis and Sam Dutton" style="width: 100%" /></a>

<p>Here's a screencast: <a href="https://www.youtube.com/watch?v=tD0QtBUZsF4" title="Video on YouTube: screencast of WebRTC screensharing in action">youtube.com/watch?v=tD0QtBUZsF4</a></p>

<p>...and here's the code: <a href="https://www.github.com/samdutton/rtcshare" title="Github code repository for WebRTC screensharing extension">github.com/samdutton/rtcshare</a></p>

<p>In essence, we've built an experimental Chrome extension that uses <code>RTCPeerConnection</code> and <a href="http://developer.chrome.com/dev/extensions/tabCapture.html" title="chrome.tabCapture API documentation"><code>chrome.tabCapture</code></a> to share a live 'video' of a browser tab. If you want to try it out, you'll need <a href="https://www.google.com/intl/en/chrome/browser/canary.html/">Chrome Canary</a>, and you'll need to enable Experimental Extension APIs on the <em>about:flags</em> page.</p>

<p>Our prototype relies heavily on the mighty <a href="http://apprtc.appspot.com">apprtc.appspot.com</a> demo and, to be frank, it's a bit of a hack! But... it's a proof of concept, and it works.</p>

<p>Here's how we did it:</p>

<ol>

<li><p>When the user clicks the extension icon (the 'record button' next to the address bar), the extension's background script <em>background.js</em>, appends an iframe to itself, the <code>src</code> of which is <a href="https://rtcshare.appspot.com">rtcshare.appspot.com</a>. In <em>background.js</em> it's only used to get values such as <code>token</code> and <code>room_key</code>. We told you this was a hack :^}! This is a chopped and channeled version of <a href="http://apprtc.appspot.com">apprtc.appspot.com</a>. As with the apprtc example, <a href="https://rtcshare.appspot.com">rtcshare.appspot.com</a> is also used for the remote client. </p></li>


    chrome.browserAction.onClicked.addListener(function(tab) {
    	var currentMode = localStorage["capturing"];
    	var newMode = currentMode === "on" ? "off" : "on";
    
    	if (newMode === "on"){ // start capture
    		appendIframe();
    	} else { // stop capture
    		chrome.tabs.getSelected(null, function(tab){
    			localStream.stop();
    			onRemoteHangup();
    		});
    		// set icon, localStorage, etc.
    	}
    }
    

<li><p>When the iframe has loaded, <em>background.js</em> gets values from it (generated by the rtcshare.appspot.com app) and calls <code>chrome.tabCapture.capture()</code> to start capturing a live stream of the current tab.</p></li>


    function appendIframe(){
    	iframe = document.createElement("iframe");
    	iframe.src="https://rtcshare.appspot.com";
    	document.body.appendChild(iframe);
    	iframe.onload = function(){
    		iframe.contentWindow.postMessage("sendConfig", "*");
    	};
    }
    
    // serialised config object messaged by iframe when it loads
    
    window.addEventListener("message", function(event) {
    	if (event.origin !== "https://rtcshare.appspot.com"){
    		return;
    	}
     	var config = JSON.parse(event.data);
    	room_link = config.room_link; // the remote peer URL
    	token = config.token; // for messaging via Channel API
    	// more parameter set from config
    );
    
    function startCapture(){
    	chrome.tabs.getSelected(null, function(tab) {
    		var selectedTabId = tab.id;
    		chrome.tabCapture.capture({audio:true, video:true}, handleCapture); // bingo!
    	});
    }
    

<li><p>Once the live stream is available (in other words, a live 'video' of the current tab), <em>background.js</em> kicks off the peer connection process, and signalling is done via <a href="http://www.rtcshare.appspot.com">rtcshare.appspot.com</a> using XHR and Google's <a href="/appengine/docs/python/channel/overview">Channel API</a>. All in all, it works like the <a href="http://apprtc.appspot.com">apprtc</a> demo, except that the video stream communicated to the remote peer is from <code>chrome.tabCapture</code> and not <code>getUserMedia()</code>.</p></li>


    function handleCapture(stream){
    	localStream = stream; // used by RTCPeerConnection addStream();
    	initialize(); // start signalling and peer connection process
    }
    

<li><p>For demo purposes, this prototype extension opens a new tab with the URL provided by <a href="https://rtcshare.appspot.com">rtcshare.appspot.com</a>, which has a 'room number' query string added. Of course, this URL could be opened on another computer, in another place, and THAT might be the start of something useful!</p></li>


    chrome.tabs.create({url: room_link});
    

</ol>

<p>We envisage a lot of interesting use cases for screensharing and, even at this early stage of development, we're impressed at how responsive and stable plugin-free tab capture and sharing can be.</p>

<p>As ever, we welcome your comments: about this extension and about the WebRTC APIs in general. If you want to learn more about WebRTC, check out the <a href="http://www.html5rocks.com/en/tutorials/webrtc/basics/">HTML5 Rocks article</a> or our <a href="https://docs.google.com/document/d/1idl_NYQhllFEFqkGQOLv8KBK8M3EVzyvxnKkHl4SuM8/edit">Quick Start Guide</a>.</p>

<p>Happy hacking -- and best wishes for 2013 from everyone at HTML5R and WebRTC!</p>


